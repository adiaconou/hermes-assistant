<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Email Skills Manager</title>
  <style>
    :root {
      --bg-primary: #ffffff;
      --bg-secondary: #f5f5f5;
      --bg-card: #ffffff;
      --text-primary: #1a1a1a;
      --text-secondary: #666666;
      --text-muted: #999999;
      --border-color: #e0e0e0;
      --accent-color: #3b82f6;
      --accent-hover: #2563eb;
      --danger-color: #ef4444;
      --danger-hover: #dc2626;
      --success-color: #22c55e;
      --success-bg: #dcfce7;
      --warning-color: #f59e0b;
      --warning-bg: #fef9c3;
      --category-bg: #e0e7ff;
      --category-text: #3730a3;
      --shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
      --overlay-bg: rgba(0, 0, 0, 0.4);
    }

    [data-theme="dark"] {
      --bg-primary: #1a1a1a;
      --bg-secondary: #2d2d2d;
      --bg-card: #252525;
      --text-primary: #f0f0f0;
      --text-secondary: #a0a0a0;
      --text-muted: #707070;
      --border-color: #404040;
      --accent-color: #60a5fa;
      --accent-hover: #3b82f6;
      --danger-color: #f87171;
      --danger-hover: #ef4444;
      --success-color: #4ade80;
      --success-bg: #14532d;
      --warning-color: #fbbf24;
      --warning-bg: #422006;
      --category-bg: #312e81;
      --category-text: #c7d2fe;
      --shadow: 0 1px 3px rgba(0, 0, 0, 0.3);
      --overlay-bg: rgba(0, 0, 0, 0.6);
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
      background-color: var(--bg-primary);
      color: var(--text-primary);
      line-height: 1.6;
      transition: background-color 0.2s, color 0.2s;
    }

    .container {
      max-width: 960px;
      margin: 0 auto;
      padding: 20px;
    }

    header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 20px 0;
      border-bottom: 1px solid var(--border-color);
      margin-bottom: 20px;
    }

    h1 {
      font-size: 1.5rem;
      font-weight: 600;
    }

    .header-actions {
      display: flex;
      gap: 8px;
      align-items: center;
    }

    .theme-toggle {
      background: var(--bg-secondary);
      border: 1px solid var(--border-color);
      border-radius: 8px;
      padding: 8px 12px;
      cursor: pointer;
      font-size: 1.2rem;
      transition: background-color 0.2s;
    }

    .theme-toggle:hover {
      background: var(--border-color);
    }

    /* Status bar */
    .status-bar {
      background: var(--bg-secondary);
      padding: 16px 20px;
      border-radius: 8px;
      margin-bottom: 24px;
      display: flex;
      gap: 24px;
      flex-wrap: wrap;
      align-items: center;
    }

    .status-item {
      display: flex;
      flex-direction: column;
    }

    .status-label {
      font-size: 0.85rem;
      color: var(--text-secondary);
    }

    .status-value {
      font-size: 1.25rem;
      font-weight: 600;
    }

    .status-indicator {
      display: inline-block;
      width: 10px;
      height: 10px;
      border-radius: 50%;
      margin-right: 6px;
    }

    .status-indicator.active {
      background: var(--success-color);
    }

    .status-indicator.paused {
      background: var(--warning-color);
    }

    .watcher-row {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 8px 12px;
      background: var(--bg-card);
      border: 1px solid var(--border-color);
      border-radius: 6px;
      margin-top: 8px;
    }

    .watcher-phone {
      font-family: monospace;
      font-weight: 600;
    }

    .watcher-name {
      color: var(--text-secondary);
      font-size: 0.9rem;
    }

    /* Buttons */
    .btn {
      padding: 8px 16px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 0.9rem;
      border: 1px solid transparent;
      transition: all 0.2s;
      font-family: inherit;
    }

    .btn-primary {
      background: var(--accent-color);
      color: white;
      border-color: var(--accent-color);
    }

    .btn-primary:hover {
      background: var(--accent-hover);
    }

    .btn-danger {
      background: transparent;
      border-color: var(--danger-color);
      color: var(--danger-color);
    }

    .btn-danger:hover {
      background: var(--danger-color);
      color: white;
    }

    .btn-small {
      padding: 4px 10px;
      font-size: 0.85rem;
    }

    .btn-toggle {
      padding: 4px 10px;
      font-size: 0.8rem;
      border-radius: 4px;
      cursor: pointer;
      border: 1px solid var(--border-color);
      background: var(--bg-secondary);
      color: var(--text-primary);
      font-family: inherit;
    }

    .btn-toggle:hover {
      background: var(--border-color);
    }

    /* Skill cards */
    .skills-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 16px;
    }

    .skills-header h2 {
      font-size: 1.1rem;
      font-weight: 600;
    }

    .user-group {
      margin-bottom: 24px;
    }

    .user-header {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px 16px;
      background: var(--bg-secondary);
      border-radius: 8px;
      cursor: pointer;
      user-select: none;
      transition: background-color 0.2s;
    }

    .user-header:hover {
      background: var(--border-color);
    }

    .user-header .arrow {
      transition: transform 0.2s;
    }

    .user-header.collapsed .arrow {
      transform: rotate(-90deg);
    }

    .user-phone {
      font-weight: 600;
      font-family: monospace;
      font-size: 1rem;
    }

    .user-count {
      color: var(--text-secondary);
      font-size: 0.9rem;
    }

    .skills-list {
      padding: 12px 0 0 0;
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .skills-list.hidden {
      display: none;
    }

    .skill-card {
      background: var(--bg-card);
      border: 1px solid var(--border-color);
      border-radius: 8px;
      padding: 16px;
      box-shadow: var(--shadow);
    }

    .skill-card.disabled {
      opacity: 0.6;
    }

    .skill-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 8px;
    }

    .skill-name {
      font-size: 1rem;
      font-weight: 600;
    }

    .skill-actions {
      display: flex;
      gap: 6px;
      align-items: center;
    }

    .skill-description {
      color: var(--text-secondary);
      font-size: 0.9rem;
      margin-bottom: 10px;
    }

    .skill-meta {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      align-items: center;
      font-size: 0.85rem;
    }

    .skill-chip {
      background: var(--bg-secondary);
      color: var(--text-secondary);
      padding: 2px 8px;
      border-radius: 10px;
      font-size: 0.78rem;
      font-weight: 500;
      border: 1px solid var(--border-color);
    }

    .skill-chip.action-type {
      background: var(--category-bg);
      color: var(--category-text);
      border-color: transparent;
    }

    .skill-criteria {
      margin-top: 10px;
      padding: 10px 12px;
      background: var(--bg-secondary);
      border: 1px dashed var(--border-color);
      border-radius: 8px;
      font-size: 0.85rem;
      color: var(--text-secondary);
      white-space: pre-wrap;
      word-break: break-word;
    }

    /* Toggle switch */
    .toggle-switch {
      position: relative;
      display: inline-block;
      width: 40px;
      height: 22px;
    }

    .toggle-switch input {
      opacity: 0;
      width: 0;
      height: 0;
    }

    .toggle-slider {
      position: absolute;
      cursor: pointer;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: var(--border-color);
      border-radius: 22px;
      transition: 0.2s;
    }

    .toggle-slider:before {
      content: "";
      position: absolute;
      height: 16px;
      width: 16px;
      left: 3px;
      bottom: 3px;
      background: white;
      border-radius: 50%;
      transition: 0.2s;
    }

    .toggle-switch input:checked + .toggle-slider {
      background: var(--success-color);
    }

    .toggle-switch input:checked + .toggle-slider:before {
      transform: translateX(18px);
    }

    /* Modal */
    .modal-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: var(--overlay-bg);
      z-index: 100;
      align-items: center;
      justify-content: center;
    }

    .modal-overlay.active {
      display: flex;
    }

    .modal {
      background: var(--bg-card);
      border: 1px solid var(--border-color);
      border-radius: 12px;
      padding: 24px;
      width: 90%;
      max-width: 600px;
      max-height: 90vh;
      overflow-y: auto;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
    }

    .modal h2 {
      font-size: 1.2rem;
      margin-bottom: 20px;
    }

    .form-group {
      margin-bottom: 16px;
    }

    .form-group label {
      display: block;
      font-size: 0.85rem;
      font-weight: 600;
      margin-bottom: 4px;
      color: var(--text-secondary);
    }

    .form-group input,
    .form-group textarea,
    .form-group select {
      width: 100%;
      padding: 8px 12px;
      border: 1px solid var(--border-color);
      border-radius: 6px;
      background: var(--bg-primary);
      color: var(--text-primary);
      font-family: inherit;
      font-size: 0.9rem;
      transition: border-color 0.2s;
    }

    .form-group input:focus,
    .form-group textarea:focus,
    .form-group select:focus {
      outline: none;
      border-color: var(--accent-color);
    }

    .form-group textarea {
      min-height: 80px;
      resize: vertical;
    }

    .form-group .hint {
      font-size: 0.78rem;
      color: var(--text-muted);
      margin-top: 4px;
    }

    .modal-actions {
      display: flex;
      justify-content: flex-end;
      gap: 8px;
      margin-top: 20px;
    }

    .btn-cancel {
      background: var(--bg-secondary);
      color: var(--text-primary);
      border-color: var(--border-color);
    }

    .btn-cancel:hover {
      background: var(--border-color);
    }

    .loading {
      text-align: center;
      padding: 40px;
      color: var(--text-secondary);
    }

    .error {
      text-align: center;
      padding: 40px;
      color: var(--danger-color);
    }

    .empty {
      text-align: center;
      padding: 60px 20px;
      color: var(--text-secondary);
    }

    @media (max-width: 600px) {
      .container {
        padding: 12px;
      }

      header {
        padding: 12px 0;
      }

      h1 {
        font-size: 1.25rem;
      }

      .status-bar {
        padding: 12px 16px;
        gap: 16px;
      }

      .skill-header {
        flex-direction: column;
        gap: 8px;
      }

      .skill-actions {
        align-self: flex-end;
      }

      .modal {
        width: 95%;
        padding: 16px;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1>Email Skills Manager</h1>
      <div class="header-actions">
        <button class="btn btn-primary" onclick="openCreateModal()">+ New Skill</button>
        <button class="theme-toggle" id="themeToggle" title="Toggle theme">
          <span class="theme-icon"></span>
        </button>
      </div>
    </header>

    <div id="watcherStatus"></div>
    <div id="content">
      <div class="loading">Loading email skills...</div>
    </div>
  </div>

  <!-- Edit/Create Modal -->
  <div class="modal-overlay" id="modalOverlay">
    <div class="modal">
      <h2 id="modalTitle">Create Skill</h2>
      <form id="skillForm" onsubmit="saveSkill(event)">
        <input type="hidden" id="formSkillId" />
        <div class="form-group">
          <label for="formPhone">Phone Number</label>
          <input type="text" id="formPhone" required placeholder="+1234567890" />
        </div>
        <div class="form-group">
          <label for="formName">Name</label>
          <input type="text" id="formName" required placeholder="e.g. Invoice Tracker" />
        </div>
        <div class="form-group">
          <label for="formDescription">Description</label>
          <input type="text" id="formDescription" placeholder="Brief description of what this skill does" />
        </div>
        <div class="form-group">
          <label for="formMatchCriteria">Match Criteria</label>
          <textarea id="formMatchCriteria" required placeholder="Natural language description of which emails to match"></textarea>
          <div class="hint">Describe which emails should trigger this skill (e.g. "Emails from billing@example.com about invoices")</div>
        </div>
        <div class="form-group">
          <label for="formExtractFields">Extract Fields</label>
          <input type="text" id="formExtractFields" placeholder="amount, date, sender" />
          <div class="hint">Comma-separated field names to extract from matched emails</div>
        </div>
        <div class="form-group">
          <label for="formActionType">Action Type</label>
          <select id="formActionType" required>
            <option value="notify">Notify</option>
            <option value="execute_with_tools">Execute with Tools</option>
          </select>
        </div>
        <div class="form-group">
          <label for="formActionPrompt">Action Prompt</label>
          <textarea id="formActionPrompt" required placeholder="Instructions for what to do when this skill matches"></textarea>
        </div>
        <div class="form-group">
          <label for="formTools">Tools</label>
          <input type="text" id="formTools" placeholder="calendar_create, send_sms" />
          <div class="hint">Comma-separated tool names (only for "Execute with Tools" action type)</div>
        </div>
        <div class="modal-actions">
          <button type="button" class="btn btn-cancel" onclick="closeModal()">Cancel</button>
          <button type="submit" class="btn btn-primary" id="formSubmitBtn">Create</button>
        </div>
      </form>
    </div>
  </div>

  <script>
    // Theme management
    const themeToggle = document.getElementById('themeToggle');
    const themeIcon = themeToggle.querySelector('.theme-icon');

    function getPreferredTheme() {
      const saved = localStorage.getItem('theme');
      if (saved) return saved;
      return window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light';
    }

    function setTheme(theme) {
      document.documentElement.setAttribute('data-theme', theme);
      localStorage.setItem('theme', theme);
      themeIcon.textContent = theme === 'dark' ? '\u2600\uFE0F' : '\uD83C\uDF19';
    }

    setTheme(getPreferredTheme());

    themeToggle.addEventListener('click', () => {
      const current = document.documentElement.getAttribute('data-theme');
      setTheme(current === 'dark' ? 'light' : 'dark');
    });

    // State
    const content = document.getElementById('content');
    const watcherStatusEl = document.getElementById('watcherStatus');

    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    function formatDate(timestamp) {
      if (!timestamp) return 'Unknown';
      return new Date(timestamp).toLocaleString();
    }

    // --- Watcher status ---
    async function loadWatcherStatus() {
      try {
        const resp = await fetch('/admin/api/email-watcher/status');
        if (!resp.ok) throw new Error('Failed to load watcher status');
        const data = await resp.json();
        renderWatcherStatus(data.users);
      } catch (error) {
        watcherStatusEl.innerHTML = '';
      }
    }

    function renderWatcherStatus(users) {
      if (!users || users.length === 0) {
        watcherStatusEl.innerHTML = `
          <div class="status-bar">
            <div class="status-item">
              <span class="status-label">Email Watcher</span>
              <span class="status-value">No users configured</span>
            </div>
          </div>
        `;
        return;
      }

      let html = '<div class="status-bar" style="flex-direction:column;align-items:stretch;">';
      html += '<div style="display:flex;gap:24px;flex-wrap:wrap;">';
      html += `
        <div class="status-item">
          <span class="status-label">Email Watcher Users</span>
          <span class="status-value">${users.length}</span>
        </div>
      `;
      html += '</div>';

      for (const user of users) {
        const enabled = user.enabled;
        const indicatorClass = enabled ? 'active' : 'paused';
        const statusText = enabled ? 'Running' : 'Paused';
        const buttonText = enabled ? 'Pause' : 'Resume';
        html += `
          <div class="watcher-row">
            <span class="status-indicator ${indicatorClass}"></span>
            <span class="watcher-phone">${escapeHtml(user.phoneNumber)}</span>
            ${user.name ? '<span class="watcher-name">(' + escapeHtml(user.name) + ')</span>' : ''}
            <span class="skill-chip">${statusText}</span>
            ${user.historyId ? '<span class="skill-chip">History: ' + escapeHtml(user.historyId) + '</span>' : ''}
            <button class="btn-toggle" onclick="toggleWatcher('${escapeHtml(user.phoneNumber)}', ${!enabled})">${buttonText}</button>
          </div>
        `;
      }

      html += '</div>';
      watcherStatusEl.innerHTML = html;
    }

    async function toggleWatcher(phoneNumber, enabled) {
      try {
        const resp = await fetch('/admin/api/email-watcher/toggle', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ phoneNumber, enabled }),
        });
        if (!resp.ok) throw new Error('Failed to toggle watcher');
        await loadWatcherStatus();
      } catch (error) {
        alert('Error toggling watcher: ' + error.message);
      }
    }

    // --- Skills ---
    async function loadSkills() {
      try {
        const resp = await fetch('/admin/api/email-skills');
        if (!resp.ok) throw new Error('Failed to load skills');
        const data = await resp.json();
        renderSkills(data.skills);
      } catch (error) {
        content.innerHTML = '<div class="error">Error: ' + escapeHtml(error.message) + '</div>';
      }
    }

    function renderSkills(skills) {
      if (!skills || skills.length === 0) {
        content.innerHTML = `
          <div class="empty">
            <p>No email skills configured yet.</p>
            <p style="margin-top:8px;font-size:0.9rem;">Click "+ New Skill" to create one.</p>
          </div>
        `;
        return;
      }

      // Group by phone number
      const grouped = skills.reduce((acc, s) => {
        const phone = s.phoneNumber;
        if (!acc[phone]) acc[phone] = [];
        acc[phone].push(s);
        return acc;
      }, {});

      const totalCount = skills.length;
      const userCount = Object.keys(grouped).length;

      let html = `
        <div class="skills-header">
          <h2>${totalCount} skill${totalCount !== 1 ? 's' : ''} across ${userCount} user${userCount !== 1 ? 's' : ''}</h2>
        </div>
      `;

      for (const [phone, userSkills] of Object.entries(grouped)) {
        html += `
          <div class="user-group">
            <div class="user-header" onclick="toggleGroup(this)">
              <span class="arrow">\u25BC</span>
              <span class="user-phone">${escapeHtml(phone)}</span>
              <span class="user-count">(${userSkills.length} skill${userSkills.length !== 1 ? 's' : ''})</span>
            </div>
            <div class="skills-list">
              ${userSkills.map(s => renderSkillCard(s)).join('')}
            </div>
          </div>
        `;
      }

      content.innerHTML = html;
    }

    function renderSkillCard(skill) {
      const enabledClass = skill.enabled ? '' : ' disabled';
      const tools = Array.isArray(skill.tools) ? skill.tools : [];
      const extractFields = Array.isArray(skill.extractFields) ? skill.extractFields : [];

      return `
        <div class="skill-card${enabledClass}" id="skill-${skill.id}">
          <div class="skill-header">
            <span class="skill-name">${escapeHtml(skill.name)}</span>
            <div class="skill-actions">
              <label class="toggle-switch" title="${skill.enabled ? 'Disable' : 'Enable'}">
                <input type="checkbox" ${skill.enabled ? 'checked' : ''} onchange="toggleSkillEnabled('${skill.id}', this.checked)" />
                <span class="toggle-slider"></span>
              </label>
              <button class="btn btn-small btn-primary" onclick="openEditModal('${skill.id}')">Edit</button>
              <button class="btn btn-small btn-danger" onclick="deleteSkill('${skill.id}')">Delete</button>
            </div>
          </div>
          ${skill.description ? '<div class="skill-description">' + escapeHtml(skill.description) + '</div>' : ''}
          <div class="skill-meta">
            <span class="skill-chip action-type">${escapeHtml(skill.actionType)}</span>
            ${extractFields.length > 0 ? '<span class="skill-chip">Fields: ' + escapeHtml(extractFields.join(', ')) + '</span>' : ''}
            ${tools.length > 0 ? '<span class="skill-chip">Tools: ' + escapeHtml(tools.join(', ')) + '</span>' : ''}
            <span class="skill-chip">Updated: ${formatDate(skill.updatedAt)}</span>
          </div>
          <div class="skill-criteria">Match: ${escapeHtml(skill.matchCriteria)}</div>
        </div>
      `;
    }

    function toggleGroup(header) {
      header.classList.toggle('collapsed');
      const list = header.nextElementSibling;
      list.classList.toggle('hidden');
    }

    // --- Toggle skill enabled ---
    async function toggleSkillEnabled(id, enabled) {
      try {
        const resp = await fetch('/admin/api/email-skills/' + id + '/toggle', {
          method: 'PATCH',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ enabled }),
        });
        if (!resp.ok) throw new Error('Failed to toggle skill');
        await loadSkills();
      } catch (error) {
        alert('Error toggling skill: ' + error.message);
        await loadSkills();
      }
    }

    // --- Delete skill ---
    async function deleteSkill(id) {
      if (!confirm('Are you sure you want to delete this skill?')) return;

      try {
        const resp = await fetch('/admin/api/email-skills/' + id, { method: 'DELETE' });
        if (resp.status === 204 || resp.ok) {
          await loadSkills();
        } else if (resp.status === 404) {
          alert('Skill not found. It may have already been deleted.');
          await loadSkills();
        } else {
          throw new Error('Failed to delete skill');
        }
      } catch (error) {
        alert('Error deleting skill: ' + error.message);
      }
    }

    // --- Modal ---
    let allSkills = [];

    function openCreateModal() {
      document.getElementById('modalTitle').textContent = 'Create Skill';
      document.getElementById('formSubmitBtn').textContent = 'Create';
      document.getElementById('formSkillId').value = '';
      document.getElementById('formPhone').value = '';
      document.getElementById('formPhone').disabled = false;
      document.getElementById('formName').value = '';
      document.getElementById('formDescription').value = '';
      document.getElementById('formMatchCriteria').value = '';
      document.getElementById('formExtractFields').value = '';
      document.getElementById('formActionType').value = 'notify';
      document.getElementById('formActionPrompt').value = '';
      document.getElementById('formTools').value = '';
      document.getElementById('modalOverlay').classList.add('active');
    }

    function openEditModal(id) {
      // Fetch the skill data from the DOM or re-fetch
      fetch('/admin/api/email-skills')
        .then(r => r.json())
        .then(data => {
          const skill = data.skills.find(s => s.id === id);
          if (!skill) {
            alert('Skill not found');
            return;
          }

          document.getElementById('modalTitle').textContent = 'Edit Skill';
          document.getElementById('formSubmitBtn').textContent = 'Save';
          document.getElementById('formSkillId').value = skill.id;
          document.getElementById('formPhone').value = skill.phoneNumber;
          document.getElementById('formPhone').disabled = true;
          document.getElementById('formName').value = skill.name;
          document.getElementById('formDescription').value = skill.description || '';
          document.getElementById('formMatchCriteria').value = skill.matchCriteria;
          document.getElementById('formExtractFields').value = (skill.extractFields || []).join(', ');
          document.getElementById('formActionType').value = skill.actionType;
          document.getElementById('formActionPrompt').value = skill.actionPrompt;
          document.getElementById('formTools').value = (skill.tools || []).join(', ');
          document.getElementById('modalOverlay').classList.add('active');
        })
        .catch(err => alert('Error loading skill: ' + err.message));
    }

    function closeModal() {
      document.getElementById('modalOverlay').classList.remove('active');
    }

    // Close modal on overlay click
    document.getElementById('modalOverlay').addEventListener('click', (e) => {
      if (e.target === e.currentTarget) closeModal();
    });

    function parseCommaSeparated(value) {
      if (!value || !value.trim()) return [];
      return value.split(',').map(s => s.trim()).filter(Boolean);
    }

    async function saveSkill(event) {
      event.preventDefault();

      const id = document.getElementById('formSkillId').value;
      const isEdit = !!id;

      const body = {
        phoneNumber: document.getElementById('formPhone').value.trim(),
        name: document.getElementById('formName').value.trim(),
        description: document.getElementById('formDescription').value.trim(),
        matchCriteria: document.getElementById('formMatchCriteria').value.trim(),
        extractFields: parseCommaSeparated(document.getElementById('formExtractFields').value),
        actionType: document.getElementById('formActionType').value,
        actionPrompt: document.getElementById('formActionPrompt').value.trim(),
        tools: parseCommaSeparated(document.getElementById('formTools').value),
      };

      try {
        let resp;
        if (isEdit) {
          resp = await fetch('/admin/api/email-skills/' + id, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(body),
          });
        } else {
          resp = await fetch('/admin/api/email-skills', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(body),
          });
        }

        if (!resp.ok) {
          const errData = await resp.json().catch(() => ({}));
          throw new Error(errData.error || 'Failed to save skill');
        }

        closeModal();
        await loadSkills();
      } catch (error) {
        alert('Error saving skill: ' + error.message);
      }
    }

    // --- Initial load ---
    loadWatcherStatus();
    loadSkills();
  </script>
</body>
</html>
